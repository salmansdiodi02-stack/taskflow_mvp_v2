<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TaskFlow Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --text: #e6edf3;
      --accent: #007bff;
      --accent-glow: 0 0 8px #007bff99;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: #000;
      padding: 24px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: 2px 0 10px #00000066;
    }
    .sidebar h2 {
      color: var(--accent);
      font-size: 1.3rem;
      text-align: center;
    }
    .sidebar button {
      background: var(--card);
      border: none;
      color: var(--text);
      font-weight: 600;
      border-radius: 10px;
      padding: 12px;
      margin-top: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .sidebar button:hover {
      background: var(--accent);
      color: white;
      box-shadow: var(--accent-glow);
    }

    /* Main area */
    .main {
      flex: 1;
      overflow-y: auto;
      padding: 20px 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px #00000033;
      text-align: center;
    }

    .card h3 {
      font-weight: 500;
      color: #999;
    }

    .card p {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent);
    }

    .chart-container {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px #00000033;
      margin-bottom: 25px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
    }

    th, td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #222;
    }

    th {
      background: #111;
      color: #888;
      font-weight: 600;
    }

    tr:hover {
      background: #1c2129;
    }

    input {
      padding: 10px;
      border-radius: 8px;
      border: none;
      width: 300px;
      background: #1b1f26;
      color: var(--text);
    }

    #darkToggle {
      background: var(--card);
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div>
      <h2>TaskFlow</h2>
      <button id="refreshBtn">üîÑ Refresh</button>
      <button id="darkToggle">üåô Toggle Theme</button>
      <button>‚öôÔ∏è Settings</button>
    </div>
    <button id="logoutBtn">üö™ Logout</button>
  </div>

  <div class="main">
    <header>
      <h1>Admin Dashboard</h1>
      <div id="datetime"></div>
    </header>

    <div class="metrics">
      <div class="card"><h3>Total Leads</h3><p id="totalLeads">0</p></div>
      <div class="card"><h3>Revenue</h3><p id="revenue">$0</p></div>
      <div class="card"><h3>Conversion Rate</h3><p id="conversion">0%</p></div>
      <div class="card"><h3>This Week</h3><p id="weekLeads">0</p></div>
    </div>

    <div class="chart-container">
      <canvas id="leadsChart" height="100"></canvas>
    </div>

    <input id="searchBox" placeholder="üîç Search leads..." />
    <table>
      <thead>
        <tr><th>Name</th><th>Phone</th><th>Service</th><th>When</th><th>Notes</th></tr>
      </thead>
      <tbody id="leadsBody"></tbody>
    </table>
  </div>

  <script>
    const API = 'https://taskflow-mvp-v2.onrender.com';

    const ctx = document.getElementById('leadsChart');
    const leadsChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ 
        label: 'Leads Over Time', 
        data: [], 
        borderColor: '#007bff', 
        backgroundColor: '#007bff33', 
        tension: 0.4 
      }]},
      options: { scales: { y: { beginAtZero: true }}, plugins: { legend: { labels: { color: '#ccc' }}}}
    });

    async function loadLeads() {
      const res = await fetch(`${API}/api/leads-list`);
      const data = await res.json();
      renderLeads(data);
      updateMetrics(data);
    }

    function renderLeads(leads) {
      const body = document.getElementById('leadsBody');
      body.innerHTML = '';
      leads.forEach(l => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${l.name}</td><td>${l.phone}</td><td>${l.service||''}</td><td>${l.preferred||''}</td><td>${l.notes||''}</td>`;
        body.appendChild(tr);
      });
      updateChart(leads);
    }

    function updateChart(leads) {
      const days = {};
      leads.forEach(l => {
        const d = new Date(l.created_at || Date.now()).toLocaleDateString();
        days[d] = (days[d] || 0) + 1;
      });
      leadsChart.data.labels = Object.keys(days);
      leadsChart.data.datasets[0].data = Object.values(days);
      leadsChart.update();
    }

    function updateMetrics(leads) {
      document.getElementById('totalLeads').textContent = leads.length;
      const revenueMap = { "House Cleaning": 100, "Lawn Care": 120, "Painting": 150, "Plumbing": 200 };
      const revenue = leads.reduce((sum, l) => sum + (revenueMap[l.service] || 0), 0);
      document.getElementById('revenue').textContent = `$${revenue}`;
    }

    document.getElementById('refreshBtn').addEventListener('click', loadLeads);
    document.getElementById('logoutBtn').addEventListener('click', () => location.reload());
    document.getElementById('darkToggle').addEventListener('click', () => {
      const r = document.documentElement;
      const dark = r.style.getPropertyValue('--bg') === '#0d1117';
      if (dark) {
        r.style.setProperty('--bg', '#f5f7fb');
        r.style.setProperty('--card', '#fff');
        r.style.setProperty('--text', '#111');
      } else {
        r.style.setProperty('--bg', '#0d1117');
        r.style.setProperty('--card', '#161b22');
        r.style.setProperty('--text', '#e6edf3');
      }
    });

    document.getElementById('searchBox').addEventListener('input', e => {
      const q = e.target.value.toLowerCase();
      document.querySelectorAll('#leadsBody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    });

    function updateTime() {
      document.getElementById('datetime').textContent = new Date().toLocaleString();
    }
    setInterval(updateTime, 1000);
    updateTime();
    loadLeads();
  </script>
</body>
</html>
